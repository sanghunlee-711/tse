var F=Object.defineProperty;var I=(d,t,e)=>t in d?F(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var l=(d,t,e)=>I(d,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(s){if(s.ep)return;s.ep=!0;const o=e(s);fetch(s.href,o)}})();const $=1;class h{constructor(t,e,n=[],s=0){l(this,"type");l(this,"attrs");l(this,"content");l(this,"startOffset");l(this,"endOffset");this.type=t,this.attrs=e,this.content=n,this.startOffset=s,this.endOffset=this.calculateEndOffset()}static isTSENode(t){return t instanceof h&&typeof t.type=="string"&&Array.isArray(t.content)}calculateEndOffset(){let t=this.startOffset;return this.content.forEach(e=>{e instanceof h?t=Math.max(t,e.calculateEndOffset()):typeof e=="string"&&(t+=e.length)}),t}recalculateOffsets(){const t=(e,n,s=!1)=>{e.startOffset=n;let o=n,r=0;e.content.length-1;for(let i=0;i<e.content.length;i++){const c=e.content[i];r=i,typeof c=="string"?o+=c.length:c instanceof h&&(o=t(c,o))}return e.endOffset=o,e.type==="paragraph"&&!s&&(o+=$),o};t(this,0,!0)}toJSON(){return{type:this.type,attrs:this.attrs,content:this.content.map(t=>t instanceof h?t.toJSON():t)}}update(t,e=this.content){return new h(this.type,t||this.attrs,e)}getNodeLength(){return typeof this=="string"?this.length:this instanceof h?this.content.reduce((t,e)=>typeof e=="string"?t+e.length:e instanceof h?t+e.getNodeLength():t,0):0}}class C{constructor(t){l(this,"node");l(this,"dom");l(this,"selected");this.node=t,this.dom=this.createDOM(),this.selected=!1,this.addEventListeners()}createDOM(){let t;return this.node.type==="paragraph"?t=document.createElement("p"):this.node.type==="heading"?t=document.createElement(`h${this.node.attrs.level||1}`):this.node.type==="bold"?t=document.createElement("b"):this.node.type==="italic"?t=document.createElement("i"):t=document.createElement("div"),this.updateAttributes(t),this.updateContent(t),t}updateAttributes(t){this.node.attrs&&Object.entries(this.node.attrs).forEach(([e,n])=>{n?t.setAttribute(e,n):t.removeAttribute(e)})}updateContent(t){this.node.content.forEach(e=>{if(typeof e=="string")t.appendChild(document.createTextNode(e));else if(e instanceof h){const n=new C(e);t.appendChild(n.dom)}})}update(t){if(t.type!==this.node.type)return!1;this.node=t,this.updateAttributes(this.dom);const e=t.content.join("");return this.dom.textContent!==e&&this.updateContent(this.dom),!0}selectNode(){this.selected=!0,this.dom.classList.add("selected-node"),this.dom.style.outline="1px solid gray",setTimeout(()=>{this.deselectNode()},500)}deselectNode(){this.selected=!1,this.dom.classList.remove("selected-node"),this.dom.style.outline=""}onClick(t){this.selected?this.deselectNode():this.selectNode()}addEventListeners(){this.dom.addEventListener("click",this.onClick.bind(this))}removeEventListeners(){this.dom.removeEventListener("click",this.onClick.bind(this))}destroy(){this.removeEventListeners(),this.dom.remove()}ignoreMutation(t){return t.type!=="characterData"}addClass(t){this.dom.classList.add(t)}removeClass(t){this.dom.classList.remove(t)}}const R=1,P="tse";function x(d,t){var o,r;const e=document.getElementById(P);let n=d,s=t;for(;n&&n.previousSibling;){n=n.previousSibling;const i=n.nodeType===Node.ELEMENT_NODE,c=n.nodeType===Node.TEXT_NODE;if(i){const a=n;a.nodeName==="P"?(s+=((o=a.textContent)==null?void 0:o.length)||0,s+=R):s+=((r=a.textContent)==null?void 0:r.length)||0}else c&&(s+=n.length)}return n!=null&&n.parentNode&&n.parentNode!==e?s+x(n.parentNode,0):s}function L(d,t,e){const n=window.getSelection();if(!n||!e.rootElement){console.warn("Unable to update selection.");return}const s=e.state.getWindowOffsetFrom(d,t,e.rootElement);if(!s)throw new Error("windowOffset범위를 찾지 못했습니다.");const{windowStartOffset:o,windowEndOffset:r}=s,i=e.state.getWindowNodeFrom(d,t,e.rootElement),{node:c,content:a,contentIndex:f}=e.state.getNodeContentFrom(d,t),u=document.createRange();return{selection:n,windowStartOffset:o,windowEndOffset:r,windowNode:i,range:u,tseNode:c,content:a,contentIndex:f}}class v{constructor(t){l(this,"rootNode");l(this,"startOffset",0);l(this,"endOffset",0);l(this,"matchedNode",null);this.rootNode=t}updateRootNode(t){this.rootNode=t}updateSelection(){var o,r,i,c,a,f,u;const t=window.getSelection();if(!(t!=null&&t.rangeCount))return;const e=t.getRangeAt(0);this.startOffset=x(e.startContainer,e.startOffset),this.endOffset=x(e.endContainer,e.endOffset),this.matchedNode=this.findNodeByOffset(this.rootNode,this.startOffset);const n=document.getElementById("output"),s=typeof((o=this.matchedNode)==null?void 0:o.content)=="string"?this.matchedNode.content:(i=(r=this.matchedNode)==null?void 0:r.content)==null?void 0:i.join("");this.startOffset===this.endOffset?n&&(n.innerText=`커서 위치: ${this.startOffset}, 
 노드 내용: "${s}", 
 노드 범위: "${(c=this.matchedNode)==null?void 0:c.startOffset} ~ ${(a=this.matchedNode)==null?void 0:a.endOffset}"
 현재 노드 컨텐츠: ${JSON.stringify(this.rootNode.content,null,2)}`):n&&(n.textContent=`선택 범위: ${this.startOffset} ~ ${this.endOffset}, 노드 내용: "${s}", 노드 범위: "${(f=this.matchedNode)==null?void 0:f.startOffset} ~ ${(u=this.matchedNode)==null?void 0:u.endOffset}"`)}findNodeByOffset(t,e){if(typeof t=="string")return null;if(e>=t.startOffset&&e<=t.endOffset){if(typeof t.content=="string")return t;if(Array.isArray(t.content))for(const n of t.content){const s=this.findNodeByOffset(n,e);if(s)return s}return t}return null}}class B{constructor(t,e,n){l(this,"state");l(this,"rootElement");l(this,"selection");l(this,"plugins");this.rootElement=t,this.state=e,this.selection=new v(this.state.doc),this.plugins=n,this.initialRender(),this.addEventListeners(),this.initializePlugins()}initializePlugins(){this.plugins.forEach(t=>{var e;return(e=t.onInit)==null?void 0:e.call(t,this)})}dispatch(t,e){this.state=this.state.apply(t),this.state.selection=this.selection,this.state.selection.updateRootNode(this.state.doc),this.state.selection.updateSelection(),this.syncDOM(t),e&&e.afterSyncDOM&&e.afterSyncDOM(t,this)}updateDOM(t,e){for(let n=t;n<e;n++){const s=this.state.doc.content[n],o=this.rootElement.childNodes[n];if(typeof s=="string"){const r=document.createTextNode(s);o?o.nodeType===Node.TEXT_NODE?o.textContent=s:this.rootElement.replaceChild(r,o):this.rootElement.appendChild(r)}else if(s instanceof h){const r=new C(s);o?this.rootElement.replaceChild(r.dom,o):this.rootElement.appendChild(r.dom)}}}removeUselessDOM(){for(;this.rootElement.childNodes.length>this.state.doc.content.length;)this.rootElement.removeChild(this.rootElement.childNodes[this.state.doc.content.length])}syncDOM(t){if(t.changedRange){const{from:e,to:n}=t.changedRange;this.updateDOM(e,n),this.removeUselessDOM()}}initialRender(){this.rootElement.innerHTML="",this.rootElement.setAttribute("contentEditable","true"),this.state.doc.content.forEach(t=>{if(t instanceof h){const e=new C(t);this.rootElement.appendChild(e.dom)}else if(typeof t=="string"){const e=document.createTextNode(t);this.rootElement.appendChild(e)}})}addEventListeners(){this.plugins.forEach(t=>{this.rootElement.addEventListener(t.eventType,e=>{t.on(e,this)})})}}class M{constructor(t,e){l(this,"schema");l(this,"doc");l(this,"selection");this.schema=t.schema,this.doc=t.doc||this.schema.createNode("doc",{},[]),this.selection=e}apply(t){let e=this.doc;return t.steps.forEach(n=>{e=n(e)}),e.recalculateOffsets(),this.doc,new M({schema:this.schema,doc:e},this.selection)}validateRange(t,e){if(t<this.doc.startOffset||e>this.doc.endOffset)throw new Error(`범위에 맞지 않은 노드 탐색입니다, ${this.doc.type}, ${t} ${e}`)}getNodeFrom(t,e){this.validateRange(t,e);const n=o=>{if(o.startOffset<=t&&o.endOffset>=e){const i=o.content;for(let c=0;c<i.length;c++){const a=i[c];if(a instanceof h){const f=n(a);if(f)return f}}return o}return null},s=n(this.doc);if(!s)throw new Error("TSENode찾기에 실패하였습니다. 범위를 확인해주세요");return s}getNodeContentFrom(t,e){this.validateRange(t,e);const n=o=>{if(!(o.startOffset<=t&&o.endOffset>=e))return null;const i=o.content;let c=o.startOffset,a;for(let f=0;f<i.length;f++){const u=i[f];typeof u=="string"?a=u.length:a=u.endOffset-u.startOffset+R;const g=c,O=c+a;if(g<=t&&O>=e)if(u instanceof h){const m=n(u);if(m)return m}else return{node:o,contentIndex:f,content:u};c+=a}return null},s=n(this.doc);if(!s)throw new Error("해당 범위에 해당하는 content를 찾을 수 없습니다. 범위를 확인해주세요.");return s}getWindowNodeFrom(t,e,n){const s=this.doc,o=(i,c,a,f)=>{if(f<i.startOffset||a>i.endOffset)return null;let u=0;for(let O=0;O<i.content.length;O++){const p=i.content[O];if(typeof p=="string"){const m=p;m.length,i.startOffset+(p===i.content[0]?0:m===p?m.length:0)}}let g=i.startOffset;for(let O=0;O<i.content.length;O++){const p=i.content[O],m=c.childNodes[u];if(typeof p=="string"){const y=p.length,w=g,E=g+y-1;if(w<=f&&E>=a)return c.nodeType===Node.ELEMENT_NODE?c:m;g+=y,u++}else if(p instanceof h){const y=p.startOffset,w=p.endOffset;if(w>=a&&y<=f){const E=o(p,m,a,f);if(E)return E}g=w+1,u++}}return i.startOffset<=f&&i.endOffset>=a&&c.nodeType===Node.ELEMENT_NODE?c:null},r=o(s,n,t,e);if(!r)throw new Error("실제 DOM에서 찾을 수 없는 offset 범위입니다.");return r}getWindowOffsetFrom(t,e,n){this.validateRange(t,e);const s=(r,i,c,a)=>{if(a<r.startOffset||c>r.endOffset)return null;const f=Math.max(c-r.startOffset,0),u=Math.min(a-r.startOffset,r.endOffset-r.startOffset);let g=0;const O=Array.from(i.childNodes);for(let p=0;p<r.content.length;p++){const m=r.content[p],y=O[p];if(typeof m=="string"){const w=m.length,E=g,D=g+w;if(E<=u&&D>=f){const b=Math.max(f-E,0),A=Math.min(u-E,w);return{windowStartOffset:b,windowEndOffset:A}}g+=w}else if(m instanceof h){const w=s(m,y,c,a);if(w)return w;g+=m.endOffset-m.startOffset}}return f===u?{windowStartOffset:f,windowEndOffset:u}:null},o=s(this.doc,n,t,e);if(!o)throw new Error(`범위를 벗어난 offset입니다. startOffset:${t}, endOffset:${e}`);return o}toJSON(){return{schema:this.schema.spec,doc:this.doc.toJSON(),selection:this.selection}}}class W{constructor(t){l(this,"spec");l(this,"nodes");this.spec=t,this.nodes=this.compileNodes(t.nodes)}compileNodes(t){const e={};for(const[n,s]of Object.entries(t))e[n]=s;return e}createNode(t,e,n=[]){if(!this.nodes[t])throw new Error(`Undefined node type: ${t}`);return new h(t,e,n)}nodeFromJSON(t){const{type:e,attrs:n,content:s}=t;return new h(e,n,Array.isArray(s)?s.map(o=>typeof o=="object"&&o!==null?this.nodeFromJSON(o):o):s)}}class N{constructor(t){l(this,"steps",[]);l(this,"changedRange",null);l(this,"state");l(this,"startOffset",null);l(this,"endOffset",null);this.state=t,this.startOffset=this.state.selection.startOffset,this.endOffset=this.state.selection.endOffset}updateChangedRange(t,e){this.changedRange?this.changedRange={from:Math.min(this.changedRange.from,t),to:Math.max(this.changedRange.to,e)}:this.changedRange={from:t,to:e}}modifyTransactionOffset(t,e){this.startOffset=t,this.endOffset=e}addNode(t,e,n=[],s){const o=this.state.schema.createNode(t,e,n);return this.steps.push(r=>{let i=r.content;if(s){const c=r.content.slice(0,s+1),a=r.content.slice(s+1);i=[...c,o,...a],this.updateChangedRange(r.content.length,r.content.length+1)}else i=[...r.content,o],this.updateChangedRange(r.content.length,r.content.length+1);return new h(r.type,r.attrs,i)}),this}updateNodeAttrs(t,e){return this.steps.push(n=>{const s=n.content.map((o,r)=>r===t&&o instanceof h?new h(o.type,{...e},o.content,o.startOffset):o);return this.updateChangedRange(t,t+1),new h(n.type,n.attrs,s)}),this}updateNode(t){return this.steps.push(e=>{const n=i=>{if(i===t)return new h(i.type,i.attrs,t.content,i.startOffset);const c=i.content.map(a=>a instanceof h?n(a):a);return new h(i.type,i.attrs,c,i.startOffset)},s=n(e),o=t.startOffset,r=t.startOffset+t.content.reduce((i,c)=>typeof c=="string"?i+c.length:c instanceof h?i+c.endOffset-c.startOffset+R:i,0);return this.updateChangedRange(o,r),s}),this}}const T={insertText:d=>d+1,deleteText:d=>d-1};function U(d,t,e){const n=L(d,t,e);if(!n)throw new Error("범위를 찾을 수 없습니다.");const{selection:s,windowStartOffset:o,windowEndOffset:r,windowNode:i,range:c,contentIndex:a}=n,f=i.childNodes[a];c.setStart(f,T.deleteText(o)),c.setEnd(f,T.deleteText(r)),s.removeAllRanges(),s.addRange(c)}function j(d,t){const{startOffset:e,endOffset:n}=t.selection,s=t.state.getNodeFrom(e,n),{content:o,contentIndex:r}=t.state.getNodeContentFrom(e,n),i=t.state.getWindowOffsetFrom(e,n,t.rootElement);if(!i)throw new Error("windowOffset범위를 찾지 못했습니다.");const{windowStartOffset:c,windowEndOffset:a}=i,f=new N(t.state);if(typeof o=="string"){const u=o.slice(0,c-1)+o.slice(a);s.content[r]=u}else throw new Error("문자가 아닌 node가 탐색 되었습니다.");return f.updateNode(s),f}class V{constructor(){l(this,"eventType","input")}on(t,e){const n=t;if(n.inputType==="deleteContentBackward"){const s=j(n.data||"",e);e.dispatch(s,this)}}afterSyncDOM(t,e){U(t.startOffset||0,t.endOffset||0,e)}}function k(d,t,e){const n=L(d,t,e);if(!n)throw new Error("범위를 찾을 수 없습니다.");const{selection:s,windowStartOffset:o,windowEndOffset:r,windowNode:i,range:c,contentIndex:a}=n,f=i.childNodes[a];c.setStart(f,T.insertText(o)),c.setEnd(f,T.insertText(r)),s.removeAllRanges(),s.addRange(c)}function J(d,t){const{startOffset:e,endOffset:n}=t.selection,s=t.state.getNodeFrom(e,n),{content:o,contentIndex:r}=t.state.getNodeContentFrom(e,n),i=t.state.getWindowOffsetFrom(e,n,t.rootElement);if(!i)throw new Error("windowOffset범위를 찾지 못했습니다.");const{windowStartOffset:c,windowEndOffset:a}=i,f=new N(t.state);if(typeof o=="string"){const u=o.slice(0,c)+d+o.slice(a);s.content[r]=u}else throw new Error("문자가 아닌 node가 탐색 되었습니다.");return f.updateNode(s),f}class z{constructor(){l(this,"eventType","input")}on(t,e){const n=t;if(n.inputType==="insertText"){const s=J(n.data||"",e);e.dispatch(s,this)}}afterSyncDOM(t,e){k(t.startOffset||0,t.endOffset||0,e)}}class H{constructor(){l(this,"eventType","keyup")}on(t,e){e.selection.updateSelection()}}class K{constructor(){l(this,"eventType","mouseup")}on(t,e){e.selection.updateSelection()}}const X=[new z,new V,new K,new H],q={nodes:{doc:{content:"block+"},paragraph:{group:"block"},heading:{group:"block",attrs:{level:1}}}},Z=new W(q),S=document.getElementById("tse");if(S){const d=new h("doc",{id:"test"},[new h("paragraph",{},["Hello, World!"]),new h("paragraph",{},["ProseMirror-inspired editor"]),new h("paragraph",{},["Some Text is Start and ",new h("bold",{},["Bold Text"])," and more text"])]),t=new v(d),e=new M({schema:Z,doc:d},t),n=[...X],s=new B(S,e,n),o=new N(e);o.addNode("paragraph",{},["This is a new paragraph added with Transaction."]);const r=new N(e);r.addNode("paragraph",{},["Anything is Start and ",new h("italic",{},["Italic Text"])," and more text"]);const i=new N(e);i.addNode("paragraph",{},[""]),s.dispatch(o),s.dispatch(i),s.dispatch(r)}
