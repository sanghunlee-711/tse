var w=Object.defineProperty;var C=(h,t,e)=>t in h?w(h,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[t]=e;var a=(h,t,e)=>C(h,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function e(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=e(n);fetch(n.href,o)}})();const v=1;class c{constructor(t,e,s=[],n=0){a(this,"type");a(this,"attrs");a(this,"content");a(this,"startOffset");a(this,"endOffset");this.type=t,this.attrs=e,this.content=s,this.startOffset=n,this.endOffset=this.calculateEndOffset()}static isTSENode(t){return t instanceof c&&typeof t.type=="string"&&Array.isArray(t.content)}toDOM(){const t=this.content.map(e=>{if(c.isTSENode(e)){const s=e.toDOM();return s.length>0?s:null}return typeof e=="string"?e:null}).filter(e=>e!==null);return this.type==="paragraph"?["p",this.attrs,...t]:this.type==="heading"?["h"+this.attrs.level,this.attrs,...t]:["div",this.attrs,...t]}calculateEndOffset(){if(typeof this.content=="string")return this.startOffset+this.content.length;if(Array.isArray(this.content)){let t=this.startOffset;return this.content.forEach(e=>{e instanceof c?t=Math.max(t,e.calculateEndOffset()):typeof e=="string"&&(t+=e.length)}),t}return this.startOffset}recalculateOffsets(){let t=this.startOffset;const e=s=>{s.startOffset=t,typeof s.content=="string"?s.endOffset=s.startOffset+s.content.length:Array.isArray(s.content)&&(s.endOffset=s.startOffset,s.content.forEach(n=>{n instanceof c?(e(n),s.endOffset=n.endOffset):typeof n=="string"&&(s.endOffset+=n.length)})),t=s.endOffset+v};e(this)}toJSON(){return{type:this.type,attrs:this.attrs,content:this.content.map(t=>t instanceof c?t.toJSON():t)}}update(t,e=this.content){return new c(this.type,t||this.attrs,e)}diff(t){const e=[];return this.type!==t.type?(e.push({node:t,changeType:"type"}),e):(Object.entries(this.attrs).some(([n,o])=>t.attrs[n]!==o)&&e.push({node:t,changeType:"attributes"}),this.content.length!==t.content.length?e.push({node:t,changeType:"content"}):this.content.forEach((n,o)=>{const i=t.content[o];if(typeof n=="string"&&typeof i=="string")n!==i&&e.push({node:t,changeType:"content"});else if(c.isTSENode(n)&&c.isTSENode(i)){const r=n.diff(i);e.push(...r)}else n!==i&&e.push({node:t,changeType:"content"})}),e)}getNodeLength(){return typeof this=="string"?this.length:this instanceof c?this.content.reduce((t,e)=>typeof e=="string"?t+e.length:e instanceof c?t+e.getNodeLength():t,0):0}}class u{constructor(t){a(this,"steps",[]);a(this,"changedRange",null);a(this,"state");a(this,"startOffset",null);a(this,"endOffset",null);this.state=t,this.startOffset=this.state.selection.startOffset,this.endOffset=this.state.selection.endOffset}updateChangedRange(t,e){this.changedRange?this.changedRange={from:Math.min(this.changedRange.from,t),to:Math.max(this.changedRange.to,e)}:this.changedRange={from:t,to:e}}addNode(t,e,s=[]){const n=this.state.schema.createNode(t,e,s);return this.steps.push(o=>{const i=[...o.content,n];return this.updateChangedRange(o.content.length,o.content.length+1),new c(o.type,o.attrs,i)}),this}updateNodeAttrs(t,e){return this.steps.push(s=>{const n=s.content.map((o,i)=>i===t&&o instanceof c?new c(o.type,{...e},o.content,o.startOffset):o);return this.updateChangedRange(t,t+1),new c(s.type,s.attrs,n)}),this}updateNodeContents(t,e){return this.steps.push(s=>{const n=s.content.map((o,i)=>i===t&&o instanceof c?new c(o.type,o.attrs,e,o.startOffset):o);return this.updateChangedRange(t,t+1),new c(s.type,s.attrs,n)}),this}}class O{constructor(t){a(this,"node");a(this,"dom");a(this,"selected");this.node=t,this.dom=this.createDOM(),this.selected=!1,this.addEventListeners()}createDOM(){let t;return this.node.type==="paragraph"?t=document.createElement("p"):this.node.type==="heading"?t=document.createElement(`h${this.node.attrs.level||1}`):t=document.createElement("div"),this.updateAttributes(t),this.updateContent(t),t}updateAttributes(t){this.node.attrs&&Object.entries(this.node.attrs).forEach(([e,s])=>{s?t.setAttribute(e,s):t.removeAttribute(e)})}updateContent(t){t.textContent=this.node.content.join("")}update(t){if(t.type!==this.node.type)return!1;this.node=t,this.updateAttributes(this.dom);const e=t.content.join("");return this.dom.textContent!==e&&this.updateContent(this.dom),!0}selectNode(){this.selected=!0,this.dom.classList.add("selected-node"),this.dom.style.outline="2px solid blue"}deselectNode(){this.selected=!1,this.dom.classList.remove("selected-node"),this.dom.style.outline=""}onClick(t){this.selected?this.deselectNode():this.selectNode()}addEventListeners(){this.dom.addEventListener("click",this.onClick.bind(this))}removeEventListeners(){this.dom.removeEventListener("click",this.onClick.bind(this))}destroy(){this.removeEventListeners(),this.dom.remove()}ignoreMutation(t){return t.type!=="characterData"}addClass(t){this.dom.classList.add(t)}removeClass(t){this.dom.classList.remove(t)}}const E=1,T="tse";function p(h,t){var o;const e=document.getElementById(T);let s=h,n=t;for(;s&&s.previousSibling;){s=s.previousSibling;const i=((o=s.textContent)==null?void 0:o.length)||0;n+=i+(i>0?E:0)}return s!=null&&s.parentNode&&s.parentNode!==e?n+p(s.parentNode,0):n}class N{constructor(t){a(this,"rootNode");a(this,"startOffset",0);a(this,"endOffset",0);a(this,"matchedNode",null);this.rootNode=t}updateRootNode(t){this.rootNode=t}updateSelection(){var o,i,r,f,d,l,g;const t=window.getSelection();if(!(t!=null&&t.rangeCount))return;const e=t.getRangeAt(0);this.startOffset=p(e.startContainer,e.startOffset),this.endOffset=p(e.endContainer,e.endOffset),this.matchedNode=this.findNodeByOffset(this.rootNode,this.startOffset);const s=document.getElementById("output"),n=typeof((o=this.matchedNode)==null?void 0:o.content)=="string"?this.matchedNode.content:(r=(i=this.matchedNode)==null?void 0:i.content)==null?void 0:r.join("");this.startOffset===this.endOffset?s&&(s.innerText=`커서 위치: ${this.startOffset}, 노드 내용: "${n}", 노드 범위: "${(f=this.matchedNode)==null?void 0:f.startOffset} ~ ${(d=this.matchedNode)==null?void 0:d.endOffset}"`):s&&(s.textContent=`선택 범위: ${this.startOffset} ~ ${this.endOffset}, 노드 내용: "${n}", 노드 범위: "${(l=this.matchedNode)==null?void 0:l.startOffset} ~ ${(g=this.matchedNode)==null?void 0:g.endOffset}"`)}findNodeByOffset(t,e){if(typeof t=="string")return null;if(e>=t.startOffset&&e<=t.endOffset){if(typeof t.content=="string")return t;if(Array.isArray(t.content))for(const s of t.content){const n=this.findNodeByOffset(s,e);if(n)return n}return t}return null}}class L{constructor(t,e){a(this,"state");a(this,"rootElement");a(this,"selection");this.rootElement=t,this.state=e,this.selection=new N(this.state.doc),this.initialRender(),this.addEventListeners()}udpateState(t,e){this.state=t,this.selection.updateRootNode(this.state.doc),this.selection.updateSelection(),this.state.selection=this.selection,this.syncDOM(e)}syncDOM(t){if(t.changedRange){const{from:e,to:s}=t.changedRange;for(let n=e;n<s;n++){const o=this.state.doc.content[n],i=this.rootElement.childNodes[n];if(typeof o=="string"){const r=document.createTextNode(o);i?i.nodeType===Node.TEXT_NODE?i.textContent=o:this.rootElement.replaceChild(r,i):this.rootElement.appendChild(r)}else if(o instanceof c){const r=new O(o);i?this.rootElement.replaceChild(r.dom,i):this.rootElement.appendChild(r.dom)}}for(;this.rootElement.childNodes.length>this.state.doc.content.length;)this.rootElement.removeChild(this.rootElement.childNodes[this.state.doc.content.length])}this.updateCarrotPosition(t.startOffset||0,t.endOffset||0)}updateCarrotPosition(t,e){const s=window.getSelection();if(console.log("updateCarrotPos!",t,e),!s||!this.rootElement){console.warn("Unable to update selection.");return}const n=document.createRange();let o=0;const i=r=>{var f;if(r.nodeType===Node.TEXT_NODE){const d=((f=r.textContent)==null?void 0:f.length)||0;if(o+d>=t){const l=t-o;return n.setStart(r,l),n.setEnd(r,l+(e-t)),!0}o+=d}else if(r.nodeType===Node.ELEMENT_NODE){for(const d of r.childNodes)if(i(d))return!0}return!1};i(this.rootElement),s.removeAllRanges(),s.addRange(n)}dispatch(t){const e=this.state.apply(t);this.udpateState(e,t)}initialRender(){this.rootElement.innerHTML="",this.rootElement.setAttribute("contentEditable","true"),this.state.doc.content.forEach(t=>{if(t instanceof c){const e=new O(t);this.rootElement.appendChild(e.dom)}else if(typeof t=="string"){const e=document.createTextNode(t);this.rootElement.appendChild(e)}})}addEventListeners(){this.rootElement.addEventListener("input",t=>{this.handleInput(t)}),this.rootElement.addEventListener("mouseup",()=>this.selection.updateSelection()),this.rootElement.addEventListener("keyup",()=>this.selection.updateSelection())}handleInput(t){if(t.inputType==="insertText"){const e=t.data||"",s=this.createInsertTransaction(e);this.dispatch(s)}else if(t.inputType==="deleteContentBackward"){const e=this.createDeleteTransaction();this.dispatch(e)}else if(t.inputType==="Enter"){const e=this.createEnterTransaction();this.dispatch(e)}}createInsertTransaction(t){const{startOffset:e,endOffset:s}=this.selection,n=this.state.resolvePosition(e);if(!n)throw new Error("Failed to resolve position for insertText.");const{node:o,localOffset:i}=n,r=new u(this.state);return o.content.length>0&&o.content.forEach(f=>{if(typeof f=="string"){const d=f.slice(0,i)+t+f.slice(i);r.updateNodeContents(this.state.doc.content.indexOf(o),[d])}}),r}createDeleteTransaction(){const{startOffset:t,endOffset:e}=this.selection,s=this.state.resolvePosition(t);if(!s)throw new Error("Failed to resolve position for deleteContentBackward.");const{node:n,localOffset:o}=s,i=new u(this.state);return n.content.length>0&&n.content.forEach(r=>{if(typeof r=="string"){const f=r.slice(0,o-1)+r.slice(o);i.updateNodeContents(this.state.doc.content.indexOf(n),[f])}}),i}createEnterTransaction(){return new u(this.state)}}class m{constructor(t,e){a(this,"schema");a(this,"doc");a(this,"selection");this.schema=t.schema,this.doc=t.doc||this.schema.createNode("doc",{},[]),this.selection=e}apply(t){let e=this.doc;return t.steps.forEach(s=>{e=s(e)}),e.recalculateOffsets(),new m({schema:this.schema,doc:e},this.selection)}resolvePosition(t){let e=0,s=0;const n=i=>{for(const r of i.content)if(typeof r=="string"){const f=i.endOffset-i.startOffset;if(e+f>=t-s)return{node:i,localOffset:t-e-s};e+=f}else if(r instanceof c){const f=n(r);if(s+=E,f)return f}return null},o=n(this.doc);if(!o)throw new Error("Offset out of bounds");return o}toJSON(){return{schema:this.schema.spec,doc:this.doc.toJSON(),selection:this.selection}}}class b{constructor(t){a(this,"spec");a(this,"nodes");this.spec=t,this.nodes=this.compileNodes(t.nodes)}compileNodes(t){const e={};for(const[s,n]of Object.entries(t))e[s]=n;return e}createNode(t,e,s=[]){if(!this.nodes[t])throw new Error(`Undefined node type: ${t}`);return new c(t,e,s)}nodeFromJSON(t){const{type:e,attrs:s,content:n}=t;return new c(e,s,Array.isArray(n)?n.map(o=>typeof o=="object"&&o!==null?this.nodeFromJSON(o):o):n)}}const R={nodes:{doc:{content:"block+"},paragraph:{group:"block"},heading:{group:"block",attrs:{level:1}}}},A=new b(R),y=document.getElementById("tse");if(y){const h=new c("doc",{id:"test"},[new c("paragraph",{},["Hello, World!"],0),new c("paragraph",{},["ProseMirror-inspired editor"],13)]),t=new N(h),e=new m({schema:A,doc:h},t),s=new L(y,e),n=new u(e);n.addNode("paragraph",{},["This is a new paragraph added with Transaction."]);const o=new u(e);o.addNode("paragraph",{},["One More Line With Transaction!@!"]),s.dispatch(n),s.dispatch(o);const i=document.getElementById("console-button");i==null||i.addEventListener("click",()=>{console.info(e.toJSON())})}
