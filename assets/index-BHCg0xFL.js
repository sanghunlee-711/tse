var v=Object.defineProperty;var T=(f,t,e)=>t in f?v(f,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):f[t]=e;var a=(f,t,e)=>T(f,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function e(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=e(n);fetch(n.href,o)}})();const L=1;class r{constructor(t,e,s=[],n=0){a(this,"type");a(this,"attrs");a(this,"content");a(this,"startOffset");a(this,"endOffset");this.type=t,this.attrs=e,this.content=s,this.startOffset=n,this.endOffset=this.calculateEndOffset()}static isTSENode(t){return t instanceof r&&typeof t.type=="string"&&Array.isArray(t.content)}toDOM(){const t=this.content.map(e=>{if(r.isTSENode(e)){const s=e.toDOM();return s.length>0?s:null}return typeof e=="string"?e:null}).filter(e=>e!==null);return this.type==="paragraph"?["p",this.attrs,...t]:this.type==="heading"?["h"+this.attrs.level,this.attrs,...t]:["div",this.attrs,...t]}calculateEndOffset(){if(typeof this.content=="string")return this.startOffset+this.content.length;if(Array.isArray(this.content)){let t=this.startOffset;return this.content.forEach(e=>{e instanceof r?t=Math.max(t,e.calculateEndOffset()):typeof e=="string"&&(t+=e.length)}),t}return this.startOffset}recalculateOffsets(){let t=this.startOffset;const e=s=>{s.startOffset=t,typeof s.content=="string"?s.endOffset=s.startOffset+s.content.length:Array.isArray(s.content)&&(s.endOffset=s.startOffset,s.content.forEach(n=>{n instanceof r?(e(n),s.endOffset=n.endOffset):typeof n=="string"&&(s.endOffset+=n.length)})),t=s.endOffset+L};e(this)}toJSON(){return{type:this.type,attrs:this.attrs,content:this.content.map(t=>t instanceof r?t.toJSON():t)}}update(t,e=this.content){return new r(this.type,t||this.attrs,e)}diff(t){const e=[];return this.type!==t.type?(e.push({node:t,changeType:"type"}),e):(Object.entries(this.attrs).some(([n,o])=>t.attrs[n]!==o)&&e.push({node:t,changeType:"attributes"}),this.content.length!==t.content.length?e.push({node:t,changeType:"content"}):this.content.forEach((n,o)=>{const i=t.content[o];if(typeof n=="string"&&typeof i=="string")n!==i&&e.push({node:t,changeType:"content"});else if(r.isTSENode(n)&&r.isTSENode(i)){const c=n.diff(i);e.push(...c)}else n!==i&&e.push({node:t,changeType:"content"})}),e)}getNodeLength(){return typeof this=="string"?this.length:this instanceof r?this.content.reduce((t,e)=>typeof e=="string"?t+e.length:e instanceof r?t+e.getNodeLength():t,0):0}}class m{constructor(t){a(this,"steps",[]);a(this,"changedRange",null);a(this,"state");a(this,"startOffset",null);a(this,"endOffset",null);this.state=t,this.startOffset=this.state.selection.startOffset,this.endOffset=this.state.selection.endOffset}updateChangedRange(t,e){this.changedRange?this.changedRange={from:Math.min(this.changedRange.from,t),to:Math.max(this.changedRange.to,e)}:this.changedRange={from:t,to:e}}addNode(t,e,s=[]){const n=this.state.schema.createNode(t,e,s);return this.steps.push(o=>{const i=[...o.content,n];return this.updateChangedRange(o.content.length,o.content.length+1),new r(o.type,o.attrs,i)}),this}updateNodeAttrs(t,e){return this.steps.push(s=>{const n=s.content.map((o,i)=>i===t&&o instanceof r?new r(o.type,{...e},o.content,o.startOffset):o);return this.updateChangedRange(t,t+1),new r(s.type,s.attrs,n)}),this}updateNodeContents(t,e){return this.steps.push(s=>{const n=s.content.map((o,i)=>i===t&&o instanceof r?new r(o.type,o.attrs,e,o.startOffset):o);return this.updateChangedRange(t,t+1),new r(s.type,s.attrs,n)}),this}}class E{constructor(t){a(this,"node");a(this,"dom");a(this,"selected");this.node=t,this.dom=this.createDOM(),this.selected=!1,this.addEventListeners()}createDOM(){let t;return this.node.type==="paragraph"?t=document.createElement("p"):this.node.type==="heading"?t=document.createElement(`h${this.node.attrs.level||1}`):t=document.createElement("div"),this.updateAttributes(t),this.updateContent(t),t}updateAttributes(t){this.node.attrs&&Object.entries(this.node.attrs).forEach(([e,s])=>{s?t.setAttribute(e,s):t.removeAttribute(e)})}updateContent(t){t.textContent=this.node.content.join("")}update(t){if(t.type!==this.node.type)return!1;this.node=t,this.updateAttributes(this.dom);const e=t.content.join("");return this.dom.textContent!==e&&this.updateContent(this.dom),!0}selectNode(){this.selected=!0,this.dom.classList.add("selected-node"),this.dom.style.outline="1px solid gray",setTimeout(()=>{this.deselectNode()},500)}deselectNode(){this.selected=!1,this.dom.classList.remove("selected-node"),this.dom.style.outline=""}onClick(t){this.selected?this.deselectNode():this.selectNode()}addEventListeners(){this.dom.addEventListener("click",this.onClick.bind(this))}removeEventListeners(){this.dom.removeEventListener("click",this.onClick.bind(this))}destroy(){this.removeEventListeners(),this.dom.remove()}ignoreMutation(t){return t.type!=="characterData"}addClass(t){this.dom.classList.add(t)}removeClass(t){this.dom.classList.remove(t)}}const w=1,b="tse";function O(f,t){var o;const e=document.getElementById(b);let s=f,n=t;for(;s&&s.previousSibling;){s=s.previousSibling;const i=((o=s.textContent)==null?void 0:o.length)||0;n+=i+(i>0?w:0)}return s!=null&&s.parentNode&&s.parentNode!==e?n+O(s.parentNode,0):n}class C{constructor(t){a(this,"rootNode");a(this,"startOffset",0);a(this,"endOffset",0);a(this,"matchedNode",null);this.rootNode=t}updateRootNode(t){this.rootNode=t}updateSelection(){var o,i,c,h,l,u,d;const t=window.getSelection();if(!(t!=null&&t.rangeCount))return;const e=t.getRangeAt(0);this.startOffset=O(e.startContainer,e.startOffset),this.endOffset=O(e.endContainer,e.endOffset),this.matchedNode=this.findNodeByOffset(this.rootNode,this.startOffset);const s=document.getElementById("output"),n=typeof((o=this.matchedNode)==null?void 0:o.content)=="string"?this.matchedNode.content:(c=(i=this.matchedNode)==null?void 0:i.content)==null?void 0:c.join("");this.startOffset===this.endOffset?s&&(s.innerText=`커서 위치: ${this.startOffset}, 노드 내용: "${n}", 노드 범위: "${(h=this.matchedNode)==null?void 0:h.startOffset} ~ ${(l=this.matchedNode)==null?void 0:l.endOffset}"`):s&&(s.textContent=`선택 범위: ${this.startOffset} ~ ${this.endOffset}, 노드 내용: "${n}", 노드 범위: "${(u=this.matchedNode)==null?void 0:u.startOffset} ~ ${(d=this.matchedNode)==null?void 0:d.endOffset}"`)}findNodeByOffset(t,e){if(typeof t=="string")return null;if(e>=t.startOffset&&e<=t.endOffset){if(typeof t.content=="string")return t;if(Array.isArray(t.content))for(const s of t.content){const n=this.findNodeByOffset(s,e);if(n)return n}return t}return null}}class M{constructor(t,e){a(this,"state");a(this,"rootElement");a(this,"selection");this.rootElement=t,this.state=e,this.selection=new C(this.state.doc),this.initialRender(),this.addEventListeners()}udpateState(t,e){this.state=t,this.selection.updateRootNode(this.state.doc),this.selection.updateSelection(),this.state.selection=this.selection,this.syncDOM(e)}updateDOM(t,e){for(let s=t;s<e;s++){const n=this.state.doc.content[s],o=this.rootElement.childNodes[s];if(typeof n=="string"){const i=document.createTextNode(n);o?o.nodeType===Node.TEXT_NODE?o.textContent=n:this.rootElement.replaceChild(i,o):this.rootElement.appendChild(i)}else if(n instanceof r){const i=new E(n);o?this.rootElement.replaceChild(i.dom,o):this.rootElement.appendChild(i.dom)}}}removeUselessDOM(){for(;this.rootElement.childNodes.length>this.state.doc.content.length;)this.rootElement.removeChild(this.rootElement.childNodes[this.state.doc.content.length])}syncDOM(t){if(t.changedRange){const{from:e,to:s}=t.changedRange;this.updateDOM(e,s),this.removeUselessDOM()}this.updateCarrotPosition(t.startOffset||0,t.endOffset||0)}updateCarrotPosition(t,e){const s=window.getSelection();if(console.log("updateCarrotPos!",t,e),!s||!this.rootElement){console.warn("Unable to update selection.");return}const n=document.createRange();let o=0;const i=(c,h)=>{var l;if(c.nodeType===Node.TEXT_NODE){const u=((l=c.textContent)==null?void 0:l.length)||0;if(o+u>=t){const d=t-o,g=d,p=d+(e-t);return n.setStart(c,g+1),n.setEnd(c,p+1),!0}o+=u}else if(c.nodeType===Node.ELEMENT_NODE&&h){const u=h.content;for(let d=0;d<c.childNodes.length;d++){const g=c.childNodes[d],p=u[d];if(i(g,p instanceof r?p:void 0))return!0;p instanceof r&&(o+=1)}}return!1};i(this.rootElement,this.state.doc),s.removeAllRanges(),s.addRange(n)}dispatch(t){const e=this.state.apply(t);this.udpateState(e,t)}initialRender(){this.rootElement.innerHTML="",this.rootElement.setAttribute("contentEditable","true"),this.state.doc.content.forEach(t=>{if(t instanceof r){const e=new E(t);this.rootElement.appendChild(e.dom)}else if(typeof t=="string"){const e=document.createTextNode(t);this.rootElement.appendChild(e)}})}addEventListeners(){this.rootElement.addEventListener("input",t=>{this.handleInput(t)}),this.rootElement.addEventListener("mouseup",()=>this.selection.updateSelection()),this.rootElement.addEventListener("keyup",()=>this.selection.updateSelection())}handleInput(t){if(t.inputType==="insertText"){const e=t.data||"",s=this.createInsertTransaction(e);this.dispatch(s)}else if(t.inputType==="deleteContentBackward"){const e=this.createDeleteTransaction();this.dispatch(e)}else if(t.inputType==="Enter"){const e=this.createEnterTransaction();this.dispatch(e)}}createInsertTransaction(t){const{startOffset:e,endOffset:s}=this.selection,n=this.state.resolvePosition(e);if(!n)throw new Error("Failed to resolve position for insertText.");const{node:o,localOffset:i}=n,c=new m(this.state);return o.content.length>0&&o.content.forEach(h=>{if(typeof h=="string"){const l=h.slice(0,i)+t+h.slice(i);c.updateNodeContents(this.state.doc.content.indexOf(o),[l])}}),c}createDeleteTransaction(){const{startOffset:t,endOffset:e}=this.selection,s=this.state.resolvePosition(t);if(!s)throw new Error("Failed to resolve position for deleteContentBackward.");const{node:n,localOffset:o}=s,i=new m(this.state);return n.content.length>0&&n.content.forEach(c=>{if(typeof c=="string"){const h=c.slice(0,o-1)+c.slice(o);i.updateNodeContents(this.state.doc.content.indexOf(n),[h])}}),i}createEnterTransaction(){return new m(this.state)}}class y{constructor(t,e){a(this,"schema");a(this,"doc");a(this,"selection");this.schema=t.schema,this.doc=t.doc||this.schema.createNode("doc",{},[]),this.selection=e}apply(t){let e=this.doc;return t.steps.forEach(s=>{e=s(e)}),e.recalculateOffsets(),new y({schema:this.schema,doc:e},this.selection)}resolvePosition(t){let e=0,s=0;const n=i=>{for(const c of i.content)if(typeof c=="string"){const h=i.endOffset-i.startOffset;if(e+h>=t-s)return{node:i,localOffset:t-e-s};e+=h}else if(c instanceof r){const h=n(c);if(s+=w,h)return h}return null},o=n(this.doc);if(!o)throw new Error("Offset out of bounds");return o}toJSON(){return{schema:this.schema.spec,doc:this.doc.toJSON(),selection:this.selection}}}class R{constructor(t){a(this,"spec");a(this,"nodes");this.spec=t,this.nodes=this.compileNodes(t.nodes)}compileNodes(t){const e={};for(const[s,n]of Object.entries(t))e[s]=n;return e}createNode(t,e,s=[]){if(!this.nodes[t])throw new Error(`Undefined node type: ${t}`);return new r(t,e,s)}nodeFromJSON(t){const{type:e,attrs:s,content:n}=t;return new r(e,s,Array.isArray(n)?n.map(o=>typeof o=="object"&&o!==null?this.nodeFromJSON(o):o):n)}}const D={nodes:{doc:{content:"block+"},paragraph:{group:"block"},heading:{group:"block",attrs:{level:1}}}},A=new R(D),N=document.getElementById("tse");if(N){const f=new r("doc",{id:"test"},[new r("paragraph",{},["Hello, World!"],0),new r("paragraph",{},["ProseMirror-inspired editor"],13)]),t=new C(f),e=new y({schema:A,doc:f},t),s=new M(N,e),n=new m(e);n.addNode("paragraph",{},["This is a new paragraph added with Transaction."]);const o=new m(e);o.addNode("paragraph",{},["One More Line With Transaction!@!"]),s.dispatch(n),s.dispatch(o);const i=document.getElementById("console-button");i==null||i.addEventListener("click",()=>{console.info(e.toJSON())})}
