var H=Object.defineProperty;var X=(i,t,e)=>t in i?H(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var p=(i,t,e)=>X(i,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=e(n);fetch(n.href,o)}})();const q=1;class l{constructor(t,e,s=[],n=0){p(this,"type");p(this,"attrs");p(this,"content");p(this,"startOffset");p(this,"endOffset");this.type=t,this.attrs=e,this.content=s,this.startOffset=n,this.endOffset=this.calculateEndOffset()}static isTSENode(t){return t instanceof l&&typeof t.type=="string"&&Array.isArray(t.content)}calculateEndOffset(){let t=this.startOffset;return this.content.forEach(e=>{e instanceof l?t=Math.max(t,e.calculateEndOffset()):typeof e=="string"&&(t+=e.length)}),t}recalculateOffsets(){const t=(e,s,n=!1)=>{e.startOffset=s;let o=s,r=0;e.content.length-1;for(let c=0;c<e.content.length;c++){const a=e.content[c];r=c,typeof a=="string"?o+=a.length:a instanceof l&&(o=t(a,o))}return e.endOffset=o,e.type==="paragraph"&&!n&&(o+=q),o};t(this,0,!0)}toJSON(){return{type:this.type,attrs:this.attrs,content:this.content.map(t=>t instanceof l?t.toJSON():t)}}update(t,e=this.content){return new l(this.type,t||this.attrs,e)}getNodeLength(){return typeof this=="string"?this.length:this instanceof l?this.content.reduce((t,e)=>typeof e=="string"?t+e.length:e instanceof l?t+e.getNodeLength():t,0):0}}class ${constructor(t){p(this,"node");p(this,"dom");p(this,"selected");this.node=t,this.dom=this.createDOM(),this.selected=!1,this.addEventListeners()}createDOM(){let t;return this.node.type==="paragraph"?t=document.createElement("p"):this.node.type==="heading"?t=document.createElement(`h${this.node.attrs.level||1}`):this.node.type==="bold"?t=document.createElement("b"):this.node.type==="italic"?t=document.createElement("i"):this.node.type==="ul"?t=document.createElement("ul"):this.node.type==="li"?t=document.createElement("li"):t=document.createElement("div"),this.updateAttributes(t),this.updateContent(t),t}updateAttributes(t){this.node.attrs&&Object.entries(this.node.attrs).forEach(([e,s])=>{s?t.setAttribute(e,s):t.removeAttribute(e)})}updateContent(t){this.node.content.forEach(e=>{if(typeof e=="string")t.appendChild(document.createTextNode(e));else if(e instanceof l){const s=new $(e);t.appendChild(s.dom)}})}update(t){if(t.type!==this.node.type)return!1;this.node=t,this.updateAttributes(this.dom);const e=t.content.join("");return this.dom.textContent!==e&&this.updateContent(this.dom),!0}selectNode(){this.selected=!0,this.dom.classList.add("selected-node"),this.dom.style.outline="1px solid gray",setTimeout(()=>{this.deselectNode()},500)}deselectNode(){this.selected=!1,this.dom.classList.remove("selected-node"),this.dom.style.outline=""}onClick(t){this.selected?this.deselectNode():this.selectNode()}addEventListeners(){this.dom.addEventListener("click",this.onClick.bind(this))}removeEventListeners(){this.dom.removeEventListener("click",this.onClick.bind(this))}destroy(){this.removeEventListeners(),this.dom.remove()}ignoreMutation(t){return t.type!=="characterData"}addClass(t){this.dom.classList.add(t)}removeClass(t){this.dom.classList.remove(t)}}const v=1,Z="tse";function B(i,t){var o,r;const e=document.getElementById(Z);let s=i,n=t;for(;s&&s.previousSibling;){s=s.previousSibling;const c=s.nodeType===Node.ELEMENT_NODE,a=s.nodeType===Node.TEXT_NODE;if(c){const d=s;d.nodeName==="P"?(n+=((o=d.textContent)==null?void 0:o.length)||0,n+=v):n+=((r=d.textContent)==null?void 0:r.length)||0}else a&&(n+=s.length)}return s!=null&&s.parentNode&&s.parentNode!==e?n+B(s.parentNode,0):n}function z(i,t,e){const s=window.getSelection();if(!s||!e.rootElement){console.warn("Unable to update selection.");return}const n=e.state.getWindowOffsetFrom(i,t,e.rootElement);if(!n)throw new Error("windowOffset범위를 찾지 못했습니다.");const{windowStartOffset:o,windowEndOffset:r}=n,c=e.state.getWindowNodeFrom(i,t,e.rootElement),{node:a,content:d,contentIndex:f}=e.state.getNodeContentFrom(i,t),h=document.createRange();return{selection:s,windowStartOffset:o,windowEndOffset:r,windowNode:c,range:h,tseNode:a,content:d,contentIndex:f}}function j(i,t,e){const s=o=>{if(!(o.startOffset<=i&&o.endOffset>=t))return null;const c=o.content;let a=o.startOffset,d;for(let f=0;f<c.length;f++){const h=c[f];typeof h=="string"?d=h.length:d=h.endOffset-h.startOffset+v;const u=a,O=a+d;if(u<=i&&O>=t)if(h instanceof l){const g=s(h);if(g)return g}else return{node:o,contentIndex:f,content:h};a+=d}return null},n=s(e);if(!n)throw new Error("해당 범위에 해당하는 content를 찾을 수 없습니다. 범위를 확인해주세요.");return n}class V{constructor(t){p(this,"rootNode");p(this,"startOffset",0);p(this,"endOffset",0);p(this,"matchedNode",null);this.rootNode=t}updateRootNode(t){this.rootNode=t}updateSelection(){var r,c,a,d,f,h,u;const t=window.getSelection();if(!(t!=null&&t.rangeCount))return;const e=t.getRangeAt(0);this.startOffset=B(e.startContainer,e.startOffset),this.endOffset=B(e.endContainer,e.endOffset);const s=j(this.startOffset,this.endOffset,this.rootNode);if(!s)throw new Error("Selection을 통해 matchedNode찾기에 실패하였습니다.");this.matchedNode=s.node;const n=document.getElementById("output"),o=typeof((r=this.matchedNode)==null?void 0:r.content)=="string"?this.matchedNode.content:(a=(c=this.matchedNode)==null?void 0:c.content)==null?void 0:a.join("");this.startOffset===this.endOffset?n&&(n.innerText=`stateOffset: ${this.startOffset}, 
 노드 내용: "${o}", 
 노드 범위: "${(d=this.matchedNode)==null?void 0:d.startOffset} ~ ${(f=this.matchedNode)==null?void 0:f.endOffset}"
 현재 노드 컨텐츠: ${JSON.stringify(this.rootNode.content,null,2)}`):n&&(n.textContent=`선택 범위: ${this.startOffset} ~ ${this.endOffset}, 노드 내용: "${o}", 노드 범위: "${(h=this.matchedNode)==null?void 0:h.startOffset} ~ ${(u=this.matchedNode)==null?void 0:u.endOffset}"`)}}class G{constructor(t,e,s){p(this,"state");p(this,"rootElement");p(this,"selection");p(this,"plugins");this.rootElement=t,this.state=e,this.selection=new V(this.state.doc),this.plugins=s,this.initialRender(),this.addEventListeners(),this.initializePlugins()}initializePlugins(){this.plugins.forEach(t=>{var e;return(e=t.onInit)==null?void 0:e.call(t,this)})}dispatch(t,e){this.state=this.state.apply(t),this.state.selection=this.selection,this.state.selection.updateRootNode(this.state.doc),this.state.selection.updateSelection(),this.syncDOM(t),e&&e.afterSyncDOM&&e.afterSyncDOM(t,this)}updateDOM(t,e){for(let s=t;s<e;s++){const n=this.state.doc.content[s],o=this.rootElement.childNodes[s];if(typeof n=="string"){const r=document.createTextNode(n);o?o.nodeType===Node.TEXT_NODE?o.textContent=n:this.rootElement.replaceChild(r,o):this.rootElement.appendChild(r)}else if(n instanceof l){const r=new $(n);o?this.rootElement.replaceChild(r.dom,o):this.rootElement.appendChild(r.dom)}}}removeUselessDOM(){for(;this.rootElement.childNodes.length>this.state.doc.content.length;)this.rootElement.removeChild(this.rootElement.childNodes[this.state.doc.content.length])}syncDOM(t){if(t.changedRange){const{from:e,to:s}=t.changedRange;this.updateDOM(e,s),this.removeUselessDOM()}}initialRender(){this.rootElement.innerHTML="",this.rootElement.setAttribute("contentEditable","true"),this.state.doc.content.forEach(t=>{if(t instanceof l){const e=new $(t);this.rootElement.appendChild(e.dom)}else if(typeof t=="string"){const e=document.createTextNode(t);this.rootElement.appendChild(e)}})}addEventListeners(){this.plugins.forEach(t=>{this.rootElement.addEventListener(t.eventType,e=>{e.preventDefault(),t.on(e,this)})})}}class k{constructor(t,e){p(this,"schema");p(this,"doc");p(this,"selection");this.schema=t.schema,this.doc=t.doc||this.schema.createNode("doc",{},[]),this.selection=e}apply(t){let e=this.doc;return t.steps.forEach(s=>{e=s(e)}),e.recalculateOffsets(),this.doc,new k({schema:this.schema,doc:e},this.selection)}validateRange(t,e){if(t<this.doc.startOffset||e>this.doc.endOffset)throw new Error(`범위에 맞지 않은 노드 탐색입니다, ${this.doc.type}, ${t} ${e}`)}getNodeContentFrom(t,e){this.validateRange(t,e);const s=j(t,e,this.doc);if(!s)throw new Error("해당 범위에 해당하는 content를 찾을 수 없습니다. 범위를 확인해주세요.");return s}getWindowNodeFrom(t,e,s){const n=this.doc,o=(c,a,d,f)=>{if(f<c.startOffset||d>c.endOffset)return null;let h=c.startOffset;const u=Array.from(a.childNodes);for(let O=0;O<c.content.length;O++){const m=c.content[O],g=u[O];if(typeof m=="string"){const w=m.length,y=h,E=h+w;if(y<=d&&E>=f)return g;h+=w}else if(m instanceof l){h=m.startOffset;const w=o(m,g,d,f);if(w)return w;h=m.endOffset+1}}return c.startOffset<=d&&c.endOffset>=f&&a.nodeType===Node.ELEMENT_NODE?a:null},r=o(n,s,t,e);if(!r)throw new Error("실제 DOM에서 찾을 수 없는 offset 범위입니다.");return r}getWindowOffsetFrom(t,e,s){this.validateRange(t,e);const n=(r,c,a,d)=>{if(d<r.startOffset||a>r.endOffset)return null;const f=Math.max(a-r.startOffset,0),h=Math.min(d-r.startOffset,r.endOffset-r.startOffset);let u=0;const O=Array.from(c.childNodes);for(let m=0;m<r.content.length;m++){const g=r.content[m],w=O[m];if(typeof g=="string"){const y=g.length,E=u,N=u+y;if(E<=h&&N>=f){const x=Math.max(f-E,0),M=Math.min(h-E,y);return{windowStartOffset:x,windowEndOffset:M}}u+=y}else if(g instanceof l){const y=n(g,w,a,d);if(y)return y;u+=g.endOffset-g.startOffset}}return f===h?{windowStartOffset:f,windowEndOffset:h}:null},o=n(this.doc,s,t,e);if(!o)throw new Error(`범위를 벗어난 offset입니다. startOffset:${t}, endOffset:${e}`);return o}getSiblingContentFrom(t,e){this.validateRange(t,e);const s=o=>{if(!(o.startOffset<=t&&o.endOffset>=e))return null;const c=o.content;let a=o.startOffset,d;for(let f=0;f<c.length;f++){const h=c[f];typeof h=="string"?d=h.length:d=h.endOffset-h.startOffset+v;const u=a,O=a+d;if(u<=t&&O>=e)if(h instanceof l){const g=s(h);if(g)return g}else return{node:o,contents:c};a+=d}return null},n=s(this.doc);if(!n)throw new Error("해당 범위에 해당하는 content를 찾을 수 없습니다. 범위를 확인해주세요.");return n.contents}getParagraphIdxFrom(t,e){this.validateRange(t,e);const n=(o=>{const r=o.content;for(let c=0;c<r.length;c++){const a=r[c];if(a.startOffset<=t&&a.endOffset>=e)return c}return null})(this.doc);if(n===null)throw new Error("Paragraph Index 찾기에 실패하였습니다. 범위를 확인해주세요");return n}toJSON(){return{schema:this.schema.spec,doc:this.doc.toJSON(),selection:this.selection}}}class Q{constructor(t){p(this,"spec");p(this,"nodes");this.spec=t,this.nodes=this.compileNodes(t.nodes)}compileNodes(t){const e={};for(const[s,n]of Object.entries(t))e[s]=n;return e}createNode(t,e,s=[]){if(!this.nodes[t])throw new Error(`Undefined node type: ${t}`);return new l(t,e,s)}nodeFromJSON(t){const{type:e,attrs:s,content:n}=t;return new l(e,s,Array.isArray(n)?n.map(o=>typeof o=="object"&&o!==null?this.nodeFromJSON(o):o):n)}}class L{constructor(t){p(this,"steps",[]);p(this,"changedRange",null);p(this,"state");p(this,"startOffset",null);p(this,"endOffset",null);this.state=t,this.startOffset=this.state.selection.startOffset,this.endOffset=this.state.selection.endOffset}updateChangedRange(t,e){this.changedRange?this.changedRange={from:Math.min(this.changedRange.from,t),to:Math.max(this.changedRange.to,e)}:this.changedRange={from:t,to:e}}modifyTransactionOffset(t,e){this.startOffset=t,this.endOffset=e}addNode(t,e,s=[],n){const o=this.state.schema.createNode(t,e,s);return this.steps.push(r=>{let c=r.content;if(n){const a=r.content.slice(0,n+1),d=r.content.slice(n+1);c=[...a,o,...d],this.updateChangedRange(r.content.length,r.content.length+1)}else c=[...r.content,o],this.updateChangedRange(r.content.length,r.content.length+1);return new l(r.type,r.attrs,c)}),this}updateNodeAttrs(t,e){return this.steps.push(s=>{const n=s.content.map((o,r)=>r===t&&o instanceof l?new l(o.type,{...e},o.content,o.startOffset):o);return this.updateChangedRange(t,t+1),new l(s.type,s.attrs,n)}),this}updateNode(t){return this.steps.push(e=>{const s=c=>{if(c===t)return new l(c.type,c.attrs,t.content,c.startOffset);const a=c.content.map(d=>d instanceof l?s(d):d);return new l(c.type,c.attrs,a,c.startOffset)},n=s(e),o=t.startOffset,r=t.startOffset+t.content.reduce((c,a)=>typeof a=="string"?c+a.length:a instanceof l?c+a.endOffset-a.startOffset+v:c,0);return this.updateChangedRange(o,r),n}),this}}const b={insertText:i=>i+1,deleteText:i=>i-1,enterText:i=>0};function Y(i,t,e){const s=z(i,t,e);if(!s)throw new Error("범위를 찾을 수 없습니다.");const{selection:n,windowStartOffset:o,windowEndOffset:r,windowNode:c,range:a,contentIndex:d}=s,f=c.childNodes[d];console.log("in Range!!!",f.textContent),a.setStart(f,b.deleteText(o)),a.setEnd(f,b.deleteText(r)),n.removeAllRanges(),n.addRange(a)}function _(i){const{startOffset:t,endOffset:e}=i.selection,{content:s,contentIndex:n}=i.state.getNodeContentFrom(t,e),o=new L(i.state),r=i.state.getParagraphIdxFrom(t,e),c=i.state.getWindowOffsetFrom(t,e,i.rootElement);if(!c)throw new Error("windowOffset범위를 찾지 못했습니다.");const{windowStartOffset:a,windowEndOffset:d}=c,f=(u,O,m)=>{const g=u.content;for(let w=0;w<g.length;w++){const y=g[w];if(y instanceof l){const E=f(y,u,w);if(E)return E}if(y==s){const E=["bold","italic"],N=["li","ul","ol"],x=(O==null?void 0:O.type)==="paragraph"&&m!==null&&E.includes(u.type),M=N.includes((O==null?void 0:O.type)||"")&&m!==null&&N.includes(u.type),F=(O==null?void 0:O.type)==="doc"&&u.type==="paragraph"&&m!==null;if(console.log({root:u,isRawTextNode:F,isEmphasizedTextNode:x,currParagraphIdx:r,startOffset:t}),x){u.startOffset;const D=i.state.doc.content.slice(0,r-1),S=i.state.doc.content[r-1],P=i.state.doc.content[r],R=i.state.doc.content.slice(r+1),I=u.startOffset<t&&typeof y=="string",T=u.startOffset===t&&P.startOffset===t;if(console.log({root:u,prevParagraph:D,rightBeforeParagraph:S,currentParagraph:P,nextParagraph:R,currParagraphIdx:r,startOffset:t,isStartInEmphasizedNode:T}),I){const C=y.slice(0,a-1)+y.slice(d);return u.content[n]=C,u}if(T){const C=S.content[S.content.length-1];C instanceof l?C.type===u.type&&C.content:typeof C=="string"&&(u.content[0],console.log("@isStartInEmphasizedNode",{prevParagraphLastNode:C,root:u}))}}else if(F){const D=u.startOffset===t,S=i.state.doc.content.slice(0,r-1),P=i.state.doc.content[r-1],R=i.state.doc.content[r],I=i.state.doc.content.slice(r+1);if(y.slice(d),D&&r!==0)R.content.forEach(T=>{P.content.push(T)}),i.state.doc.content=[...S,P,...I];else if(typeof y=="string"){const T=y.slice(0,a-1)+y.slice(d);return u.content[n]=T,u}return i.state.doc}else M&&console.log("welcome listNode","currentType : ",u.type);return i.state.doc}}return null},h=f(i.state.doc,null,null);if(!h)throw new Error("문단 찾지 못한 에러 같습니다.");return console.log({result:h}),o.updateNode(h),o}class tt{constructor(){p(this,"eventType","input")}on(t,e){if(t.inputType==="deleteContentBackward"){const n=_(e);e.dispatch(n,this)}}afterSyncDOM(t,e){Y(t.startOffset||0,t.endOffset||0,e)}}function et(i,t,e){const s=z(i,t,e);if(!s)throw new Error("범위를 찾을 수 없습니다.");const{selection:n,windowStartOffset:o,windowEndOffset:r,windowNode:c,range:a,contentIndex:d}=s,f=c.childNodes[d].parentNode;a.setStart(f,b.enterText(o)),a.setEnd(f,b.enterText(r)),n.removeAllRanges(),n.addRange(a)}function nt(i){const{startOffset:t,endOffset:e}=i.selection,s=t-1>0?t-1:0,n=e-1>0?e-1:0,{content:o,contentIndex:r}=i.state.getNodeContentFrom(s,n),c=new L(i.state),a=i.state.getParagraphIdxFrom(s,n),d=i.state.getWindowOffsetFrom(s,n,i.rootElement);if(!d)throw new Error("windowOffset범위를 찾지 못했습니다.");const{windowStartOffset:f,windowEndOffset:h}=d,u=(m,g,w)=>{const y=m.content;for(let E=0;E<y.length;E++){const N=y[E];if(N instanceof l){const x=u(N,m,E);if(x)return x}if(N===o){const x=["bold","italic"],M=["li","ul","ol"],F=(g==null?void 0:g.type)==="paragraph"&&w!==null&&x.includes(m.type),D=M.includes((g==null?void 0:g.type)||"")&&w!==null&&M.includes(m.type),S=(g==null?void 0:g.type)==="doc"&&m.type==="paragraph"&&w!==null;if(F){const P=i.state.doc.content.slice(0,a),R=i.state.doc.content[a],I=i.state.doc.content.slice(a+1),T=N.slice(0,f),C=N.slice(h),A=new l("paragraph",{},[...R.content.slice(0,w),new l(m.type,{},[T])]),W=new l("paragraph",{},[new l(m.type,{},[C]),...R.content.slice(w+1)]);return i.state.doc.content=[...P,A,W,...I],i.state.doc}else if(S){const P=i.state.doc.content.slice(0,a),R=i.state.doc.content[a],I=i.state.doc.content.slice(a+1),T=N.slice(0,f),C=N.slice(h),A=R.content.slice(0,r),W=R.content.slice(r+1),J=new l("paragraph",{},[...A,T]),K=new l("paragraph",{},[C,...W]);return i.state.doc.content=[...P,J,K,...I],i.state.doc}else D&&console.log("welcome listNode","currentType : ",m.type);return i.state.doc}}return null},O=u(i.state.doc,null,null);if(!O)throw new Error("문단 찾지 못한 에러 같습니다.");return console.log({result:O}),c.updateNode(O),c}class st{constructor(){p(this,"eventType","keyup")}on(t,e){if(t.key==="Enter"){const n=nt(e);e.dispatch(n,this)}}afterSyncDOM(t,e){et(t.startOffset||0,t.endOffset||0,e)}}function ot(i,t,e){const s=z(i,t,e);if(!s)throw new Error("범위를 찾을 수 없습니다.");const{selection:n,windowStartOffset:o,windowEndOffset:r,windowNode:c,range:a,contentIndex:d}=s;console.log(c,d);const f=c;console.log(f),a.setStart(f,b.insertText(o)),a.setEnd(f,b.insertText(r)),n.removeAllRanges(),n.addRange(a)}function rt(i,t){const{startOffset:e,endOffset:s}=t.selection,{content:n,contentIndex:o,node:r}=t.state.getNodeContentFrom(e,s),c=t.state.getWindowOffsetFrom(e,s,t.rootElement);if(!c)throw new Error("windowOffset범위를 찾지 못했습니다.");const{windowStartOffset:a,windowEndOffset:d}=c,f=new L(t.state);if(console.log({content:n,contentIndex:o,node:r}),typeof n=="string"){const h=n.slice(0,a)+i+n.slice(d);r.content[o]=h}else throw new Error("문자가 아닌 node가 탐색 되었습니다.");return f}class it{constructor(){p(this,"eventType","input")}on(t,e){const s=t;if(s.inputType==="insertText"){const n=rt(s.data||"",e);e.dispatch(n,this)}}afterSyncDOM(t,e){ot(t.startOffset||0,t.endOffset||0,e)}}class ct{constructor(){p(this,"eventType","keyup")}on(t,e){e.selection.updateSelection()}}class at{constructor(){p(this,"eventType","mouseup")}on(t,e){e.selection.updateSelection()}}const dt=[new it,new tt,new at,new ct,new st],lt={nodes:{doc:{content:"block+"},paragraph:{group:"block"},heading:{group:"block",attrs:{level:1}}}},ft=new Q(lt),U=document.getElementById("tse");if(U){const i=new l("doc",{id:"test"},[new l("paragraph",{},["Hello, World!"]),new l("paragraph",{},["ProseMirror-inspired editor"]),new l("paragraph",{},["Some Text is Start and ",new l("bold",{},["Bold Text"])," and more text"]),new l("paragraph",{},[new l("ul",{},[new l("li",{},["list1"]),new l("li",{},["list2"]),new l("li",{},["list3"])])])]),t=new V(i),e=new k({schema:ft,doc:i},t),s=[...dt],n=new G(U,e,s),o=new L(e);o.addNode("paragraph",{},["This is a new paragraph added with Transaction."]);const r=new L(e);r.addNode("paragraph",{},["Anything is Start and ",new l("italic",{},["Italic Text"])," and more text"]);const c=new L(e);c.addNode("paragraph",{},[""]),n.dispatch(o),n.dispatch(c),n.dispatch(r)}
